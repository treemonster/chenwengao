<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
<script src="d406894cfa4abad298d58c7b414562d6.js"></script>
<script src="91620078a585e5bdb8800b8a10c6713f.js"></script>
<script src="ccac98ae433a8aa600476534a7176a62.js"></script>
<link href="172a73b72f7c34c71e23b75fc6b0072c.css" type='text/css' rel='stylesheet' />
<link href="a07e1e35d2e6f45540bf0cc2f4a6f11d.css" type='text/css' rel='stylesheet' />
<link href="d59d419069a47caa82d90c1f3cae2ba5.css" type='text/css' rel='stylesheet' />

<title>PHP使用SMTP发送邮件</title>

<body class="readonly github-io">
<div class='tabc'>
<div class='datelist-btn white-btn'>展开目录</div>
<div class="tabsr">
  <div class="tabsr-title">PHP使用SMTP发送邮件</div>
  <div class="tabsr-tags"><span class="tagz" style="background: #e1bfd7">php</span><span class="tagz" style="background: #787c75">smtp</span><span class="tagz" style="background: #e9e805">邮件</span></div>
</div>
</div>
<div class='datelist'>
  <div class='searchdiv'>
    <div class='datelist-btn-close white-btn'>X</div>
    <div class="inexport text">
      陈尼玛的博客
    </div>
    <div class="description">记录开发生涯的踩坑经历，用时间来验证成长</div>
    <input id='searchtitle' placeholder="搜索标题" />
  </div>
  <div id='lst'></div>
</div>

<div id='loading1'>加载中<span></span></div>

<div id="content">
<div id="content2"><p>因为一个项目中需要用邮件通知的功能，在网上搜了别人写的发邮件函数，要么太长，要么根本用不了。。索性自己写了一个，实现了基本的邮箱发送功能，并且可以发送多个附件。 </p>
<p>完整的代码和使用方法如下，因为暂时不需要用到向多方发送、抄送、密送功能，所以这里面并没有写这些，不过这些都很简单，后面如果用到我会更新这篇文章的代码。 </p>
<pre><code class="language-php">&lt;?php
/***********************************
 * PHP使用SMTP发送邮件
 * Author: treemonster
 * 使用中有任何问题可在下面留言
 ------------------------------------
 * 使用方式：
  try{
    new sendmail(
      &#39;xxxx@qq.com&#39;,  // 接收者邮箱
      &#39;yyyy@qq.com&#39;,  // 发送者邮箱
      &#39;xxxx&#39;, // 发送者邮箱的密码
      &#39;xxxx&#39;, // 邮件标题
      &#39;helo&lt;h1&gt;sb&lt;/h1&gt;&#39;, // 邮件html内容
      array(&#39;a.php&#39;,&#39;b.jpg&#39;,&#39;c.rar&#39;) // 附件地址，可以多个，大小没有要求
     );
  }catch(Exception $e){
    // 如果发送失败会报错，然后你可以随便怎么搞了
    echo $e-&gt;getMessage();
  }
 ************************************/
class sendmail{
  private $cli;
  private function read(){
    $r=fgets($this-&gt;cli);
    // 除了1,2,3开头的状态码均为错误码
    if(false===strpos(&#39;123&#39;,$r[0]))throw new Exception(&#39;Error: &#39;.$r);
    return $r;
  }
  private function send($data){
    fwrite($this-&gt;cli,$data);
  }

  function __construct($to,$from,$password,$subject,$htmlbody,$attachment=null){
    $f=explode(&#39;@&#39;,$from);
    $user=$f[0];
    $host=&#39;smtp.&#39;.$f[1];
    $subject=str_replace(&quot;\r\n&quot;,&#39; &#39;,$subject);

    // 连接smtp服务器
    $cli=fsockopen($host,25);
    $this-&gt;cli=&amp;$cli;

    // boundary
    $boundary=&#39;----=&#39;.uniqid();

    // 基本应答命令
    foreach(array(
      &#39;HELO SB&#39;,
      &#39;AUTH LOGIN&#39;,
      base64_encode($user),
      base64_encode($password),
      &#39;MAIL FROM:&lt;&#39;.$from.&#39;&gt;&#39;,
      &#39;RCPT TO: &lt;&#39;.$to.&#39;&gt;&#39;,
      &#39;DATA&#39;
      ) as $c){
      $this-&gt;read();
      $this-&gt;send($c.&quot;\r\n&quot;);
    } $this-&gt;read();

    // 发送邮件头部
    $this-&gt;send(
      &#39;From: &#39;.$from.&quot;\r\n&quot;.
      &#39;To: &#39;.$to.&quot;\r\n&quot;.
      &#39;Subject: &#39;.$subject.&quot;\r\n&quot;.
      &#39;Content-Type: multipart/mixed;boundary=&quot;&#39;.$boundary.&#39;&quot;&#39;.&quot;\r\n&quot;.
      &#39;MIME-Version: 1.0&#39;.&quot;\r\n\r\n\r\n&quot;);

    // 内容里的boundary比头部的多两个横线
    $boundary=&#39;--&#39;.$boundary;

    // 发送邮件内容
    $this-&gt;send(
      $boundary.&quot;\r\n&quot;.
      &#39;Content-Transfer-Encoding: base64&#39;.&quot;\r\n&quot;.
      &#39;Content-Type: text/html; charset=utf-8&#39;.&quot;\r\n&quot;.
      &quot;\r\n\r\n&quot;.
      base64_encode($htmlbody).&quot;\r\n&quot;.
      $boundary.&quot;\r\n&quot;);

    // 发送附件
    if($attachment===null);else for($i=0;$i&lt;count($attachment);$i++){
      $filename=$attachment[$i];
      $this-&gt;send(
        $boundary.&quot;\r\n&quot;.
        &#39;Content-Transfer-Encoding: base64&#39;.&quot;\r\n&quot;.
        &#39;Content-Type: application/octet-stream;&#39;.&quot;\r\n&quot;.
        &#39;Content-Disposition: attachment; filename=&quot;&#39;.str_replace(dirname($filename).&#39;/&#39;,&#39;&#39;,$filename).&#39;&quot;&#39;.&quot;\r\n&quot;.
        &quot;\r\n\r\n&quot;);
      // 不使用file_get_contents，因为有时候附件会很大
      $f=fopen($filename,&#39;rb&#39;);
      while(!feof($f))
        // 每次读取长度为3的整数倍，因为base64编码是以3为单位分段的
        $this-&gt;send(base64_encode(fread($f,5130)));
      $this-&gt;send(&quot;\r\n&quot;.$boundary.&quot;\r\n&quot;);
    }

    // 发送内容结束标志
    $this-&gt;send(&quot;.\r\n&quot;);
    $this-&gt;read();
    fclose($cli);
  }
}</code></pre>
<p>大部分原理在代码的注释中都写了。发邮件协议比较简单，全局是一问一答的模式。实现功能主要是注意规定的格式，应答完成要发送\r\n，需要base64编码的内容不能发原文，boundary中间数据的\r\n不能漏掉等。 </p>
<blockquote>
<h3 id="相关文档">相关文档</h3>
</blockquote>
<ol>
<li><p><a href="88206.html">sendmail用nginx做代理</a></p>
</li>
<li><p><a href="88181.html">树莓派配置收发邮件</a></p>
</li>
<li><p><a href="88094.html">随机取某个概率区间的代码</a></p>
</li>
<li><p><a href="58846.html">php session文件过多的问题</a></p>
</li>
<li><p><a href="58834.html">php5.2.17 curl openssl的配置踩坑</a></p>
</li>
<li><p><a href="58827.html">x64系统编译php5.3报错</a></p>
</li>
<li><p><a href="58817.html">无脑破解phpjm加密</a></p>
</li>
<li><p><a href="58815.html">php解析ini文件</a></p>
</li>
<li><p><a href="58812.html">无聊的刷屏</a></p>
</li>
<li><p><a href="58784.html">php switch的问题</a></p>
</li>
</ol>
<blockquote>
<h3 id="随便看看">随便看看</h3>
</blockquote>
<ol>
<li><p><a href="khd18njm.lhb.html">cnpm 立即同步</a></p>
</li>
<li><p><a href="kh4hp4u7.5l8.html">react项目webpack打包时拆分异步加载的文件</a></p>
</li>
<li><p><a href="kh4hp4ut.68c.html">华为等国产手机rem宽度超过实际宽度</a></p>
</li>
<li><p><a href="kh4hp4xw.fuh.html">mac 终端运行后台程序如何在终端关闭时继续运行</a></p>
</li>
<li><p><a href="kh4hp51g.d79.html">SSL certificate problem: self signed certificate in certificate chain</a></p>
</li>
<li><p><a href="kh4hp53u.pjh.html">树莓派实现用pi用户自动登录</a></p>
</li>
<li><p><a href="kh4hp54d.xb.html">git删除远程分支</a></p>
</li>
<li><p><a href="kh4hp596.lj.html">webrtc泄漏本地ip信息</a></p>
</li>
<li><p><a href="kh4hp5by.jnt.html">webpack使用外部资源</a></p>
</li>
<li><p><a href="kh4hp5ct.4ys.html">putty使用http代理连接服务器</a></p>
</li>
<li><p><a href="kh4hp5e1.ou.html">git 设置代理服务器</a></p>
</li>
<li><p><a href="kh4hp5fb.n3u.html">把树莓派的存储空间拓展到整张TF卡中</a></p>
</li>
<li><p><a href="88246.html">centos查看最近一次的开机时间</a></p>
</li>
<li><p><a href="88229.html">mysql导出csv文件</a></p>
</li>
<li><p><a href="88096.html">简易版事件封装</a></p>
</li>
<li><p><a href="87823.html">youku电脑版跳过广告代码</a></p>
</li>
<li><p><a href="79547.html">前端性能观察器</a></p>
</li>
<li><p><a href="75739.html">平面旋转</a></p>
</li>
</ol>

</div>
<div id="SOHUCS" sid="58774" ></div>
</div>

<div class="body-mask"></div>

<script type="text/javascript">
window.dd_qid="58774";
</script>
<script src="3287a981a890e10d9ffc6af37b73ff89.js"></script>
</body>
