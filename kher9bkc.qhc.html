<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
<script src="d406894cfa4abad298d58c7b414562d6.js"></script>
<script src="91620078a585e5bdb8800b8a10c6713f.js"></script>
<script src="ccac98ae433a8aa600476534a7176a62.js"></script>
<link href="172a73b72f7c34c71e23b75fc6b0072c.css" type='text/css' rel='stylesheet' />
<link href="a07e1e35d2e6f45540bf0cc2f4a6f11d.css" type='text/css' rel='stylesheet' />
<link href="d59d419069a47caa82d90c1f3cae2ba5.css" type='text/css' rel='stylesheet' />

<title>定长消息队列读写优化</title>

<body class="readonly github-io">
<div class='tabc'>
<div class='datelist-btn white-btn'>展开目录</div>
<div class="tabsr">
  <div class="tabsr-title">定长消息队列读写优化</div>
  <div class="tabsr-tags"><span class="tagz" style="background: #aa84ec">优化</span></div>
</div>
</div>
<div class='datelist'>
  <div class='searchdiv'>
    <div class='datelist-btn-close white-btn'>X</div>
    <div class="inexport text">
      陈尼玛的博客
    </div>
    <div class="description">记录开发生涯的踩坑经历，用时间来验证成长</div>
    <input id='searchtitle' placeholder="搜索标题" />
  </div>
  <div id='lst'></div>
</div>

<div id='loading1'>加载中<span></span></div>

<div id="content">
<div id="content2"><p>nodejs写聊天室消息存储的场景，比如一个房间的消息个数最多保留<font color="blue">最近的100条</font>，如果只是把消息存储在内存里，往往会使用如下写法：</p>
<pre><code class="language-javascript">var msgs=[], n=100
onmessage=msg=&gt;{
  msgs.push(msg) // 往队尾追加数据
  if(msgs.length&gt;n) msgs.shift() // 如果超过长度则把队头的删除
}</code></pre>
<p><code>push</code>操作对性能不会有什么影响，因为仅仅是往原本的数据后面增加一项，如果数组长度没有超过上次预分配的内存空间则本次操作只会往已有内存的最近一格填入一个数据。但<code>shift</code>操作问题就大了，没有优化过的代码，常规操作是从队头删除一个数据，删除之后把后面的数据各往前移动一格。因此<code>shift</code>操作理论上会比<code>push</code>慢得多。</p>
<p>因为消息队列是一个<font color="blue">定长顺序队列</font>，因此我想到的优化方案是：</p>
<ol>
<li><p>增加一个变量seq_i用于记录当前数据的尾部</p>
</li>
<li><p>每增加一个数据，则seq_i加1对消息数组的最大长度取余数，且把本次数据放到消息数组的seq_i这格</p>
</li>
<li><p>获取结果时，从seq_i开始到队列结尾的数据记为A，从0到seq_i为止的数据记为B，把A和B拼在一起就是当前的数据结果</p>
</li>
</ol>
<p>然后我写了脚本以测试效果：</p>
<pre><code class="language-javascript">
function typeA(seq_maxlen, repeat) {
  let seq=[]
  function get_result() {
    return [...seq]
  }
  function snapshot() {
    const r={
      mem: (process.memoryUsage().heapUsed/1024/1024).toFixed(2),
      time: Date.now(),
    }
    seq.push(r)
    if(seq.length&gt;seq_maxlen) seq.shift()
  }

  const a=Date.now()
  for(let i=0; i&lt;repeat; i++) snapshot()
  get_result()
  return Date.now()-a
}

function typeB(seq_maxlen, repeat) {
  let seq=[], seq_i=0
  function get_result() {
    return [...seq.slice(seq_i, seq_maxlen), ...seq.slice(0, seq_i)]
  }
  function snapshot() {
    const r={
      mem: (process.memoryUsage().heapUsed/1024/1024).toFixed(2),
      time: Date.now(),
    }
    seq[seq_i]=r
    seq_i=(seq_i+1)%seq_maxlen
  }

  const a=Date.now()
  for(let i=0; i&lt;repeat; i++) snapshot()
  get_result()
  return Date.now()-a
}


function log(seq_maxlen, repeat) {
  console.log(`队列最长${seq_maxlen}，循环${repeat}次，shift-push方式耗时：${typeA(seq_maxlen, repeat)}ms, 下标轮询方式耗时：${typeB(seq_maxlen, repeat)}ms`)
}

log(10, 1e5)
log(10, 1e6)
log(50, 1e5)
log(50, 1e6)
log(100, 1e5)
log(100, 1e6)
log(200, 1e5)
log(200, 1e6)
</code></pre>
<p><img src="577975d168f1ff99352e0ef936e85d1f" alt="image.png"></p>
<blockquote>
<h3 id="相关文档">相关文档</h3>
</blockquote>
<ol>
<li><p><a href="87991.html">数据库清理优化</a></p>
</li>
<li><p><a href="69351.html">缓存才是优化的终极手段</a></p>
</li>
</ol>
<blockquote>
<h3 id="随便看看">随便看看</h3>
</blockquote>
<ol>
<li><p><a href="kh4hp4ut.68c.html">华为等国产手机rem宽度超过实际宽度</a></p>
</li>
<li><p><a href="kh4hp4v9.83f.html">安卓文字偏上，文字顶部被遮罩</a></p>
</li>
<li><p><a href="kh4hp4ya.6e.html">ipsec vpn 添加新账号</a></p>
</li>
<li><p><a href="kh4hp4yo.gfd.html">nodejs 长连接</a></p>
</li>
<li><p><a href="kh4hp51g.d79.html">SSL certificate problem: self signed certificate in certificate chain</a></p>
</li>
<li><p><a href="kh4hp52g.1h.html">nodejs本地双向代理 端口转发</a></p>
</li>
<li><p><a href="kh4i04i8.s1n.html">nodejs socks5</a></p>
</li>
<li><p><a href="kh4hp574.hum.html">heroku登陆cli</a></p>
</li>
<li><p><a href="kh4hp5b6.kdr.html">树莓派配置wifi热点</a></p>
</li>
<li><p><a href="kh4hp5d7.f8n.html">git配置服务端支持http认证</a></p>
</li>
<li><p><a href="kh4hp5e1.ou.html">git 设置代理服务器</a></p>
</li>
<li><p><a href="kh4ib7jk.t1.html">mongodb2.4 添加用户</a></p>
</li>
<li><p><a href="88206.html">sendmail用nginx做代理</a></p>
</li>
<li><p><a href="88128.html">centos7 开放或者关闭端口</a></p>
</li>
<li><p><a href="87991.html">数据库清理优化</a></p>
</li>
<li><p><a href="79547.html">前端性能观察器</a></p>
</li>
<li><p><a href="75653.html">判断点是否在多边形内</a></p>
</li>
</ol>

</div>
<div id="SOHUCS" sid="kher9bkc.qhc" ></div>
</div>

<div class="body-mask"></div>

<script type="text/javascript">
window.dd_qid="kher9bkc.qhc";
</script>
<script src="3287a981a890e10d9ffc6af37b73ff89.js"></script>
</body>
